---
- name: Delete Virtual Machine and all associated resources
  azure.azcollection.azure_rm_virtualmachine:
    resource_group: "{{ vm_resource_group }}"
    name: "{{ vm_name }}"
    state: absent
  retries: 40
  delay: 5
  register: result
  until: result.failed == false

- name: Delete Availability set
  azure.azcollection.azure_rm_availabilityset:
    resource_group: "{{ vm_resource_group }}"
    name: "{{ availability_set }}"
    state: absent
  retries: 40
  delay: 5
  register: result
  until: result.failed == false

- name: Delete a Network Interface
  azure.azcollection.azure_rm_networkinterface:
    name: "{{ networking_interface }}"
    resource_group: "{{ vm_resource_group }}"
    state: absent
  retries: 40
  delay: 5
  register: result
  until: result.failed == false

- name: Delete a Network Interface's Autogenerated Security Group
  azure.azcollection.azure_rm_securitygroup:
    name: "{{ networking_interface }}"
    resource_group: "{{ vm_resource_group }}"
    state: absent
  retries: 40
  delay: 5
  register: result
  until: result.failed == false

- name: Delete Public IP
  azure.azcollection.azure_rm_publicipaddress:
    resource_group: "{{ vm_resource_group }}"
    name: "{{ public_ip }}"
    state: absent
  retries: 40
  delay: 5
  register: result
  until: result.failed == false

# Delete Storage accounts
# default storage account name is <vm name>XXXX,
# where XXXX is a random number and vm_name if re.sub('[^a-zA-Z0-9]', '', self.name[:20].lower())
- name: Get facts for Storage accounts in a resource group
  azure_rm_storageaccount_info:
    resource_group: "{{ vm_resource_group }}"
  register: sa_info

- name: Delete Storage account
  azure_rm_storageaccount:
    resource_group: "{{ vm_resource_group }}"
    name: "{{ item }}"
    state: absent
    force_delete_nonempty: true
  when: item[:-4] == vm_name[:20]|regex_replace('-','')
  loop: "{{ sa_info.storageaccounts | map(attribute='name') | list }}"
  retries: 40
  delay: 5
  register: result
  until: result.failed == false

- name: Delete Subnet
  azure.azcollection.azure_rm_subnet:
    state: absent
    resource_group: "{{ vm_resource_group }}"
    virtual_network: "{{ virtual_network }}"
    name: "{{ subnet }}"
  retries: 40
  delay: 5
  register: result
  until: result.failed == false

- name: Delete Virtual network
  azure.azcollection.azure_rm_virtualnetwork:
    state: absent
    resource_group: "{{ vm_resource_group }}"
    name: "{{ virtual_network }}"
  retries: 40
  delay: 5
  register: result
  until: result.failed == false
