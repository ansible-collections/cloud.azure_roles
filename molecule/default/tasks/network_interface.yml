---
- name: Define resource group name
  set_fact:
    resource_group: "test-{{ lookup('password', '/dev/null chars=ascii_lowercase,digits length=6') }}"
    azure_tags:
      cloud.azure_roles: network_interface

- name: Define network interface variables
  set_fact:
    azure_resource_group: "{{ resource_group }}"
    azure_region: 'canadacentral'
    nic_instances: 2
    azure_virtual_network: "{{ resource_group }}-vnet-00"
    azure_subnet: "{{ resource_group }}-subnet-00"
    azure_vnet_address_prefixes_cidr:
      - 10.16.0.0/16
    azure_subnet_address_prefixes_cidr: 10.16.0.0/24

- name: Test network interface role
  block:
    - name: Test valid creation of network interface w/ no load balancer
      block:
        - name: Create NICs
          include_role:
            name: network_interface
          vars:
            operation: "create"
            azure_network_interface_name: "{{ resource_group }}-nic{{ idx }}"
          loop: "{{ range(0, (nic_instances | int)) | list }}"
          loop_control:
            index_var: idx

        - name: Get resource group info
          azure_rm_resourcegroup_info:
            name: '{{ azure_resource_group }}'
          register: rg

        - name: Assert that resource group was created
          assert:
            that:
              - rg.resourcegroups | length == 1

        - azure_rm_networkinterface_info:
            resource_group: '{{ azure_resource_group }}'
          register: nics_info

        - name: Assert that network interfaces were successfully created and not attached to lb
          assert:
            that:
              - "nics_info.networkinterfaces | length == {{ nic_instances | int }}"
              - nics_info.networkinterfaces[0].ip_configurations[0].load_balancer_backend_address_pools is none

    - name: Test updating network interface w/ load balancer
      block:
        - name: Update NICs to include load balancer
          include_role:
            name: network_interface
          vars:
            operation: "create"
            azure_load_balancer:
              name: "{{ azure_resource_group }}-lb"
            azure_network_interface_name: "{{ resource_group }}-nic{{ idx }}"
          loop: "{{ range(0, (nic_instances | int)) | list }}"
          loop_control:
            index_var: idx

        - name: Get NICs info
          azure_rm_networkinterface_info:
            resource_group: '{{ azure_resource_group }}'
          register: nics_info

        - name: Assert that network interfaces still exist and are attached to lb
          assert:
            that:
              - "nics_info.networkinterfaces | length == {{ nic_instances | int }}"
              - nics_info.networkinterfaces[idx].ip_configurations[0].load_balancer_backend_address_pools is not none
          loop: "{{ range(0, (nic_instances | int)) | list }}"
          loop_control:
            index_var: idx

        - name: Delete NICs
          include_role:
            name: network_interface
          vars:
            operation: "delete"
            azure_network_interface_name: "{{ resource_group }}-nic{{ idx }}"
          loop: "{{ range(0, (nic_instances | int)) | list }}"
          loop_control:
            index_var: idx

        - azure_rm_networkinterface_info:
            resource_group: '{{ azure_resource_group }}'
          register: nics_info

        - name: Assert that network interfaces were successfully deleted
          assert:
            that:
              - nics_info.networkinterfaces | length == 0

    - name: Test creating network interface w/ load balancer
      block:
        - name: Create NICs w/ load balancer
          include_role:
            name: network_interface
          vars:
            operation: "create"
            azure_load_balancer:
              name: "{{ azure_resource_group }}-lb"
            azure_network_interface_name: "{{ resource_group }}-nic{{ idx }}"
          loop: "{{ range(0, (nic_instances | int)) | list }}"
          loop_control:
            index_var: idx

        - azure_rm_networkinterface_info:
            resource_group: '{{ azure_resource_group }}'
          register: nics_info

        - name: Assert that network interfaces were created
          assert:
            that:
              - "nics_info.networkinterfaces | length == {{ nic_instances | int }}"

        - name: Assert that network interface is attached to load balancer
          assert:
            that:
              - nics_info.networkinterfaces[0].ip_configurations[0].load_balancer_backend_address_pools is not none

    - name: Test updating network interface to remove load balancer
      block:
        - name: Update NICs
          include_role:
            name: network_interface
          vars:
            operation: "create"
            azure_network_interface_name: "{{ resource_group }}-nic{{ idx }}"
          loop: "{{ range(0, (nic_instances | int)) | list }}"
          loop_control:
            index_var: idx

        - azure_rm_networkinterface_info:
            resource_group: '{{ azure_resource_group }}'
          register: nics_info

        - name: Assert that network interfaces still exist
          assert:
            that:
              - "nics_info.networkinterfaces | length == {{ nic_instances | int }}"

        - name: Assert that network interface is not attached to load balancer
          assert:
            that:
              - nics_info.networkinterfaces[0].ip_configurations[0].load_balancer_backend_address_pools is none

    - name: Test cleanup of network interfaces
      block:
        - azure_rm_networkinterface_info:
            resource_group: '{{ azure_resource_group }}'
          register: nics_info

        - azure_rm_securitygroup_info:
            resource_group: '{{ azure_resource_group }}'
          register: sgs_info

        - name: Pre-flight check
          assert:
            that:
              - nics_info.networkinterfaces | length == 2
              - sgs_info.securitygroups | length == 2
              - nics_info.networkinterfaces[0].name == "{{ resource_group }}-nic0"
              - nics_info.networkinterfaces[1].name == "{{ resource_group }}-nic1"
              - sgs_info.securitygroups[0].name == "{{ resource_group }}-nic0"
              - sgs_info.securitygroups[1].name == "{{ resource_group }}-nic1"

        - name: Delete NIC with autogenerated security group
          include_role:
            name: network_interface
          vars:
            operation: "delete"
            azure_network_interface_name: "{{ resource_group }}-nic0"

        - azure_rm_networkinterface_info:
            resource_group: '{{ azure_resource_group }}'
          register: nic_info

        - azure_rm_securitygroup_info:
            resource_group: '{{ azure_resource_group }}'
          register: sgs_info

        - name: Assert that network interface AND security group were successfully deleted
          assert:
            that:
              - nic_info.networkinterfaces | length == 1
              - sgs_info.securitygroups | length == 1
              - nic_info.networkinterfaces[0].name == "{{ resource_group }}-nic1"
              - sgs_info.securitygroups[0].name == "{{ resource_group }}-nic1"

        - name: Update remaining NIC with custom security group
          include_role:
            name: network_interface
          vars:
            operation: "create"
            azure_network_interface_name: "{{ resource_group }}-nic1"
            azure_security_group: "{{ resource_group }}-sg"

        - name: Delete NIC with custom security group - should not remove security group
          include_role:
            name: network_interface
          vars:
            operation: "delete"
            azure_network_interface_name: "{{ resource_group }}-nic1"

        - azure_rm_networkinterface_info:
            resource_group: '{{ azure_resource_group }}'
          register: nic_info

        - azure_rm_securitygroup_info:
            resource_group: '{{ azure_resource_group }}'
          register: sgs_info

        - name: Assert that network interface was successfully deleted but security group was not
          assert:
            that:
              - nic_info.networkinterfaces | length == 0
              - sgs_info.securitygroups | length == 1
              - sgs_info.securitygroups[0].name == "{{ resource_group }}-sg"

  always:
    - name: Delete resource group
      azure_rm_resourcegroup:
        name: "{{ azure_resource_group }}"
        state: absent
        force_delete_nonempty: yes
      ignore_errors: yes
